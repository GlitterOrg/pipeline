<html>
  <head>
    <script src="../parse-css/parse-css.js"></script>
    <script src="../closure-library/closure/goog/base.js"></script>
    <script src="deps.js"></script>
    <script>goog.require('css');</script>
    <style>

      .resize-triggers {
        visibility: hidden;
      }

      .resize-triggers, .resize-triggers > div, .contract-trigger:before {
        content: " ";
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }

      .resize-triggers > div {
        background: #eee;
        overflow: auto;
      }

      .contract-trigger:before {
        width: 200%;
        height: 200%;
      }
    </style>
  </head>
  <body>
    Hi.
    <div id="foo" style="position:absolute; top:20px; left:20px; width:100px; height: 100px; background-color:red;"></div>
    <script>

function g(a, b, c){for(m=9e9;c>0;c-=a+++b+++1)m=Math.min(m, c%a&&a-c%a, c%b&&b-c%b, c>a+b+1?9e9:a+b+1-c);return m}

(function(){
  function resetTriggers(element) {
    var triggers = element.__resizeTriggers__;
    var expand = triggers.firstElementChild;
    var contract = triggers.lastElementChild;
    var expandChild = expand.firstElementChild;
    contract.scrollLeft = contract.scrollWidth;
    contract.scrollTop = contract.scrollHeight;
    expandChild.style.width = expand.offsetWidth + 1 + 'px';
    expandChild.style.height = expand.offsetHeight + 1 + 'px';
    expand.scrollLeft = expand.scrollWidth;
    expand.scrollTop = expand.scrollHeight;
  }

  function checkTriggers(element){
    return element.offsetWidth != element.__resizeLast__.width ||
           element.offsetHeight != element.__resizeLast__.height;
  }
                
  function scrollListener(e) {
    var element = this;
    e.preventDefault();
    if (checkTriggers(element)) {
      element.__resizeLast__.width = element.offsetWidth;
      element.__resizeLast__.height = element.offsetHeight;
      resetTriggers(element);
      element.__resizeListeners__.forEach(function(fn){
        fn.call(element, e);
      });
    }
  }
        
  window.addResizeListener = function(element, fn){
    if (!element.__resizeTriggers__) {
      if (getComputedStyle(element).position == 'static') element.style.position = 'relative';
      element.__resizeLast__ = {};
      element.__resizeListeners__ = [];
      (element.__resizeTriggers__ = document.createElement('div')).className = 'resize-triggers';
      element.__resizeTriggers__.innerHTML = '<div class="expand-trigger"><div></div></div>' +
                                                                                 '<div class="contract-trigger"></div>';
      element.appendChild(element.__resizeTriggers__);
      resetTriggers(element);
      element.addEventListener('scroll', scrollListener, true);
    }
    element.__resizeListeners__.push(fn);
  };
  
  window.removeResizeListener = function(element, fn){
    element.__resizeListeners__.splice(element.__resizeListeners__.indexOf(fn), 1);
    if (!element.__resizeListeners__.length) {
      element.removeEventListener('scroll', scrollListener);
      element.__resizeTriggers__ = !element.removeChild(element.__resizeTriggers__);
    }
  }
        
})();

addResizeListener(document.getElementById('foo'), function(e) {
      window.console.log(e);
      document.getElementById('foo').style.width = '100px';
    });

    </script>
  </body>
</html>
